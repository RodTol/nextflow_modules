nextflow.enable.dsl=2
cleanup=true

includeConfig "$baseDir/modules/config/params.config"

 singularity {
     enabled = true
     runOptions = '--bind /orfeo:/orfeo'
 }
 
process {
   executor='slurm'
   queue='THIN'
   errorStrategy = 'finish'
}

process {

  withName: 'VEP_ANNOTATE' {
    time='12h'
    container = 'https://depot.galaxyproject.org/singularity/ensembl-vep:110.1--pl5321h2a3209d_0'
  }

  withName: 'VCF2MAF' {
      container = 'quay.io/biocontainers/mulled-v2-b6fc09bed47d0dc4d8384ce9e04af5806f2cc91b:305092c6f8420acd17377d2cc8b96e1c3ccb7d26-0'
  }

  withName: 'PLATYPUS_CALL_VARIANTS' {
    time='24h'
    container = 'https://depot.galaxyproject.org/singularity/platypus-variant%3A0.8.1.1--htslib1.5_0'
  }

  withName: 'BCFTOOLS_SPLIT_VEP' {
      container = 'https://depot.galaxyproject.org/singularity/bcftools%3A1.14--hde04aa1_1'
  }

  withName: 'SEQUENZA_EXTRACT' {
      cpus = '20' 
      time='24h'
      memory = '200 GB'
      errorStrategy = 'finish' 
      container = 'https://depot.galaxyproject.org/singularity/sequenza-utils%3A3.0.0--py39he10ea66_6'  
}

  withName: 'CNAqc' {
    memory = '100 GB'
    time = '3h'
    errorStrategy = 'finish'

    container = 'file:///orfeo/LTS/CDSLab/LT_storage/shared/containers/singularity/cdslab.sif'

    ext.args = {[
      "cna_caller": params.cna_caller,
      "variant_caller": params.cna_variant_caller,
      "matching_strategy": params.cna_matching_strategy
    ]}
}

  withName: 'SEQUENZA_CNAqc' {
    memory = '300 GB'
    time = '3h'
    errorStrategy = 'finish'

    container = 'file:///orfeo/LTS/CDSLab/LT_storage/shared/containers/singularity/cdslab.sif'
    //scratch = '/orfeo/LTS/LADE/LT_storage/lvaleriani/tmp'

    ext.args = {[
      "norm_method": params.seqcna_norm_method,
      "window": params.seqcna_window,
      "gamma": params.seqcna_gamma,
      "kmin": params.seqcna_kmin,
      "min_reads_baf": params.seqcna_min_reads_baf,
      "min_reads": params.seqcna_min_reads,
      "min_reads_normal": params.seqcna_reads_normal,
      "max_mut_types": params.seqcna_max_mut_types,

      "low_cell": params.seqcna_low_cell,
      "up_cell": params.seqcna_up_cell,
      "low_ploidy": params.seqcna_low_ploidy,
      "up_ploidy": params.seqcna_up_ploidy,
      "delta_cellularity": params.seqcna_delta_cellularity,
      "delta_ploidy": params.seqcna_delta_ploidy,

      "matching_strategy": params.seqcna_matching_strategy
      ]}
  }
}
